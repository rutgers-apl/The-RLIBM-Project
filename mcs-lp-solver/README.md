# The Maximum Consensus LP Solver with FP Solutions for RLIBM Constraints

Given a set of infeasible (or feasible) low-dimensional linear
constraints, the maximum consensus solver produces a FP solution in
double precision that satisfies a maximum number of constraints. It
computes the convex hull in 2-D dimensions to identify a superset of
violated constraints, splits the system into a feasible subset and a
set of violated constraints. The implementation of the Clarkson's
method from the RLIBM project is used to identify the basis of the
feasible set. Subsequently, a new linear program that satisfies a
maximum number of constraints in the violated set while satisfying all
the constraints in the feasible set. See more details about this
approach
[here](https://people.cs.rutgers.edu/~sn349/papers/maxfs-pldi-2024.pdf).

## Dependencies

To build the MCS solver, we need the following packages to be installed.

* GMP - GNU Multiple Precision Arithmetic Library
* MPFR - The GNU MPFR library
* CGAL

You can install these on a Debian Linux distribution with the following command

``` 
sudo apt-get install libgmp-dev libmpfr-dev libcgal-dev     
```

You also need SOPLEX-4.0.1 installed and the following environment
variables set.


```
export SOPLEX_INCLUDE=<src directory of the SOPLEX-4.0.1>
export SOPLEX_LIB=<full path to libsoplex.a>
```
SOPLEX can be downloaded from [here](https://github.com/scipopt/soplex/releases/tag/release-401).

## Building the MCS-Solver

First, build the convex hull generator and the feasible LDLP solver by
executing the make command in the root directory of the mcs-lp-solver.

```
make
```

Then, build the maximum consensus linear program generator and
iterative version of maximum consensus formulation with the feasible
LDLP solver by executing the make command in the maxfs sub-directory.

```
cd maxfs
make
```

## Solving Infeasible LDLPs with the MCS-LP solver

We will illustrate the process of using the MCS-LP solver using the
linear constraints for log2f function.

### Identifying the constraints on the Convex Hull

Assuming you have the LP constraints in the format (3 doubles)
generated by RLIBM's interval generator (from the interval_gen
folder), you can use the hull to identify a set of constraints on the
convex hull as follows.

```
./gen_hull Log2Intervals log.config log2
```

The first argument to gen_hull is the LP constraints file for the
function of interest. The second argument is the configuration file
for the log2 function that specifies the number of terms in the
polynomial and their degrees. The sample configuration file log.config
is as below.

```
1
6 1 2 3 4 5 6
```

It states that we are generating 1 polynomial and there are 6 terms
and the respective degrees of the terms are 1, 2, 3, 4, 5, and 6.

The third argument is the name of the function whose linear
constraints are being solved. It is primarily used to name
intermediate files. 


### Identifying the Feasible LDLP and Basis of the Feasible LDLP

To identify the basis of the feasible LDLP, execute the following
command

```
./polygen Log2Intervals log.config log2_upper_hull_indices.txt log2_lower_hull_indices.txt log2
```

The first argument to polygen is the LP constraints file for the
function of interest. The second argument is the configuration file
for the function of interest. The third and fourth argument are the
indices of the upper and lower hull constraints produced by gen_hull.
The fifth argument is the name of the function used for the logs.

Executing the above program produces a file named
log2_sampled_indices.txt, which consists of constraints that were in
the sample that solved the entire feasible subset. It includes the
basis constraints for the feasible LDLP.


### Create the Superset of Violated Constraints

Concatenate the constraints identified by gen_hull into a single file with the following commands.

```
cat log2_upper_hull_indices.text > log2_violated.text
cat log2_lower_hull_indices.txt >> log2_violated.txt
```


### Run the Maximum consensus LP solver for the Basis and the Violated Constraints

Run the following command to create the maximum consensus LP
formulation for the basis constraints and the superset of violated constraints.

```
./maxfs/maxfs Log2Intervals log2_sampled_indices.txt log2_violated.txt log.config
```

The first argument is the file containing the LP constraints for the
function of interest. The second argument is the set of constraints in
the sample that solved the feasible LDLP (i.e., approximation for the
basis). The third argument is the superset of violated constraints
(which is union of the upper hull and lower hull constraints). The
fourth argument is the configuration file.

This program maxfs also creates a file called log2_violated_inputs
that indicates the constraints that have been violated by the
generated solution.


### Iterative Maximum Consensus with Clarkson's method

To remove the bias that may arise due to choice of fixed basis and the
rounding of coefficients to floating point values, execute the maximum
consensus for the formulation for the reduced violated constraints
identified by the solution from the previous step along with the
iterative Clarkson's algorithm with the following command

```
./maxfs/clarkson_maxfs Log2Intervals  log2_violated_inputs log.config 11 log2
```

The first argument is the LP constraints for the function of
interest. The second argument is the nearly maximum consensus solution
generated by using the basis of the feasible LDLP and the superset of
the violated constraints from the convex hull.  Third argument is the
configuration file. The fourth argument is the final number of
violated constraints that we seek to find in the final solution. The
fifth argument is the name of the function.