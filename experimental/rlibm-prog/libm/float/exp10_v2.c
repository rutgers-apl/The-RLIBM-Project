#include <math.h>
#include "float_lib.h"
#include "exp2.h"

float rlibm_fast_exp10_v2(float x) {
  float_x fx;
  fx.f = x;
  
  // Take care of special cases
  if (0x421a209b <= fx.x && fx.x <= 0xb25e5bd8) {
    if (fx.x <= 0x7F800000) return 1.0/0.0;
    if (fx.x < 0x80000000) return 0.0/0.0;
    return 1.0;
  }
  
  if (fx.x <= 0x32de5bd8) {
    return 1.0;
  }
  
  if (fx.x >= 0xc2349e36) {
    if (fx.x <= 0xFF800000) return 0.0;
    return 0.0/0.0;
  }
  
  // Perform range reduction
  double xp = x * 2.12603398072791179629348334856331348419189453125e+02;
  int N = (int)xp;
  int N2 = N % 64;
  if (N2 < 0) N2 += 64;
  int N1 = N - N2;
  
  int M = N1 / 64;
  int J = N2;
  double R = x - N *
  4.703593682249706219022922226713490090332925319671630859375e-03;
  
  double y;
  y = 2.85382269753145419599604792892932891845703125e+03;
  y *= R;
  y += 2.403136241469219225308506793226115405559539794921875;
  y *= R;
  y += 0.4649359427365962194045323485624976456165313720703125;
  y *= R;
  y += 1.1711679918858728388642020945553667843341827392578125;
  y *= R;
  y += 2.0346789757382683916375754051841795444488525390625;
  y *= R;
  y += 2.650949056232295486523753424989990890026092529296875;
  y *= R;
  y += 2.302585092994210214101258316077291965484619140625;
  y *= R;
  y += 0.99999999999999900079927783735911361873149871826171875;
    
  // Perform output compensation
  return y * ldexp(exp2JBy64[J], M);
}
