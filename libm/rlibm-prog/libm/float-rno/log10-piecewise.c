#include "float-rno/float_rno_lib.h"
#include "log10.h"
#include "math.h"

#define LOG102HIGH 0.30102999566398114250631579125183634459972381591796875
#define LOG102LOW  5.27074231034726570126349709198449199648263806413338306011695522101945243775844573974609375e-17

double rlibm_rno_log10_piecewise(float x) {
  float_x fix, fit;
  fix.f = x;
  int m = 0;

  if (fix.x < 0x800000 || fix.x >= 0x7F800000) {
      if ((fix.x & 0x7FFFFFFF) == 0) { // log(+/-0) = -infty
          fix.x = 0xFF800000;
          return fix.f;
      }
      
      if (fix.x > 0x7FFFFFFF) { // Log(-val) = NaN
          return (x - x) / 0;
          
      }
      
      if (fix.x >= 0x7F800000) {
          return x + x;
      }
      
      fix.f *= 8.388608e+06;
      m -= 23;
  }

  switch (fix.x) {
  case 0x3f800000 : return 0.0;
  case 0x41200000 : return 1.0;
  case 0x42c80000 : return 2.0;
  case 0x447a0000 : return 3.0;
  case 0x461c4000 : return 4.0;
  case 0x47c35000 : return 5.0;
  case 0x49742400 : return 6.0;
  case 0x4b189680 : return 7.0;
  case 0x4cbebc20 : return 8.0;
  case 0x4e6e6b28 : return 9.0;
  case 0x501502f9 : return 10.0;
  }
  
  m += fix.x >> 23;
  m -= 127;
  fix.x &= 0x007FFFFF;
  fix.x |= 0x3F800000;
  
  fit.x = fix.x & 0x007F0000;
  int FIndex = fit.x >> 16;
  fit.x |= 0x3F800000;
  
  double f = fix.f - fit.f;
  f *= log_oneByF[FIndex];

  double y;

  if (f < 2.6440486729702099115424385189498934778384864330291748046875e-03) {
    if (f < 1.32204691569010415221063770019327421323396265506744384765625e-03) {
      // 1st sub-domain
      y = -9.57374587585813341394924691485357470810413360595703125e-02;
      y *= f;
      y += 1.44734225322291354398629437127965502440929412841796875e-01;
      y *= f;
      y += -2.171472180440001953360962261285749264061450958251953125e-01;
      y *= f;
      y += 4.34294481897818551718870594413601793348789215087890625e-01;
      y *= f;
    } else {
      // 2nd sub-doomain
      if (f == 2.1962431288257088478343970194828216335736215114593505859375e-03) {
        y = 9.52769693548433972696276583747021504677832126617431640625e-04;
      } else {
        y = -9.99285086142560341482266039747628383338451385498046875e-02;
        y *= f;
        y += 1.447154119801130345290829382065567187964916229248046875e-01;
        y *= f;
        y += -2.171471466953001916433407814110978506505489349365234375e-01;
        y *= f;
        y += 4.34294481844514856927474966141744516789913177490234375e-01;
        y *= f;
      }
    }
  } else {
    if (f < 3.95805722191220309136294730478766723535954952239990234375e-03) {
      // 3rd sub-domain
      if (f == 3.051298901550751618838575041081639938056468963623046875e-03) {
        y = 1.32314440169836928552771215805705651291646063327789306640625e-03;
      } else if (f == 3.401854327905957757482990899688957142643630504608154296875e-03) {
        y = 1.4748992865482070391269786568955169059336185455322265625e-03;
      } else {
        y = -1.0611245823868138693502061187245999462902545928955078125e-01;
        y *= f;
        y += 1.447453811871166617919470809283666312694549560546875e-01;
        y *= f;
        y += -2.171471806274622995402978631318546831607818603515625e-01;
        y *= f;
        y += 4.34294481837811441327090733466320671141147613525390625e-01;
        y *= f;
      }
    } else {
      // 4th sub-domain
      y = 7.399211637817504350067565610515885055065155029296875e-01;
      y *= f;
      y += -1.2353144313050777591822537715415819548070430755615234375e-01;
      y *= f;
      y += 1.44891603798996404517396285882568918168544769287109375e-01;
      y *= f;
      y += -2.17147712880516874367486934715998359024524688720703125e-01;
      y *= f;
      y += 4.34294482554899496928868529721512459218502044677734375e-01;
      y *= f;
    }
  }
  
  y += m * LOG102LOW;
  y += log10_lut[FIndex];
  y += m * LOG102HIGH;
  
  return y;
}
