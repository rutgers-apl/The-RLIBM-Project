#include <math.h>
#include "float_lib.h"
#include "log.h"

#define LN2HIGH 0.69314718055994528622676398299518041312694549560546875

float rlibm_fast_log(float x){

  float_x fix, fit;
  fix.f = x;
  int m = 0;
  
  if (fix.x < 0x800000 || fix.x >= 0x7F800000) {
    if ((fix.x & 0x7FFFFFFF) == 0) { // log(+/-0) = -infty
      fix.x = 0xFF800000;
      return fix.f;
    }
    
    if (fix.x > 0x7FFFFFFF) { // Log(-val) = NaN
      return (x - x) / 0;
    }
    
    if (fix.x >= 0x7F800000) {
      return x + x;
    }
    
    fix.f *= 8.388608e+06;
    m -= 23;
  }
  
  m += fix.x >> 23;
  m -= 127;
  fix.x &= 0x007FFFFF;
  fix.x |= 0x3F800000;
  
  fit.x = fix.x & 0x007F0000;
  int FIndex = fit.x >> 16;
  fit.x |= 0x3F800000;
  
  double f = fix.f - fit.f;
  f *= log_oneByF[FIndex];

  double_x df;
  df.d = f;

  double y = 0.0;

  switch(df.x){
  case 0x3ea8000000000000:
    y = 7.1525548150930262636393308639526367187500000000000000000000000000000000e-07;
    break;
  case 0x3ec4000000000000:
    y = 2.3841829488446819595992565155029296875000000000000000000000000000000000e-06;
    break;
  case 0x3ecc000000000000:
    y = 3.3378545367668266408145427703857421875000000000000000000000000000000000e-06;
    break;
  case 0x3f5b1e36942462c2:
    y = 1.6537827823970563390076904397574253380298614501953125000000000000000000e-03;
    break;
  case 0x3f5ca10842108421:
    y = 1.7458519320220911019703180500073358416557312011718750000000000000000000e-03;
    break;
  case 0x3f5e962465ea2941:
    y = 1.8651071621197945482606428413419052958488464355468750000000000000000000e-03;
    break;
  case 0x3f657497b425ed09:
    y = 2.6156484501205783284316641612576859188266098499298095703125000000000000e-03;
    break;
  case 0x3f6e5c9c9c9c9c9c:
    y = 3.6994188099324647363286278078930990886874496936798095703125000000000000e-03;
    break;
  case 0x3f6e8a1fd1b7af01:
    y = 3.7210405045140786291224532789101431262679398059844970703125000000000000e-03;
    break;
  case 0x3f740970e4f80cb8:
    y = 4.8798851483051611591101881515442073578014969825744628906250000000000000e-03;
    break;
  case 0x3f769171c71c71c7:
    y = 5.4946695063801467839859071773389587178826332092285156250000000000000000e-03;
    break;
  case 0x3f787dee95c4ca03:
    y = 5.9616658636434255447156260743213351815938949584960937500000000000000000e-03;
    break;
  case 0x3f78eee000000000:
    y = 6.0687314253300428390502929687500000000000000000000000000000000000000000e-03;
    break;
  case 0x3f79ce3f8868a470:
    y = 6.2804448794122691782093603762859856942668557167053222656250000000000000e-03;
    break;
  case 0x3f79ce4000000000:
    y = 6.2804471235722303390502929687500000000000000000000000000000000000000000e-03;
    break;
  case 0x3f7a486d6f63aa04:
    y = 6.3962286501419119907896337906549888430163264274597167968750000000000000e-03;
    break;
  case 0x3f7ef7e000000000:
    y = 7.5321726035326719284057617187500000000000000000000000000000000000000000e-03;
    break;
  case 0x3f7f97515d457516:
    y = 7.6830767347698617625306738432300335261970758438110351562500000000000000e-03;
    break;
  case 0x3f7f9fc000000000:
    y = 7.6910567004233607382723825196535472059622406959533691406250000000000000e-03;
    break;
    
  default:
    y = -2.4701849787770102651052184228319674730300903320312500000000000000000000e-01;
    y *= f;
    y += 3.3331858406935049865538189806102309376001358032226562500000000000000000e-01;
    y *= f;
    y += -4.9999997170426246917429580207681283354759216308593750000000000000000000e-01;
    y *= f;
    y += 9.9999999998274702317502260484616272151470184326171875000000000000000000e-01;
    y *= f;
    y += 7.0064923216240853546186479164495806564013097093825788587853414194489554e-46;
  }
  
  y += ln_lutHIGH[FIndex];
  y += m * LN2HIGH;
  
  return y;
}
