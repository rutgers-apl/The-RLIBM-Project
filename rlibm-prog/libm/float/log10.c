#include <math.h>
#include "float_lib.h"
#include "log10.h"


#define LOG102HIGH 0.30102999566398114250631579125183634459972381591796875
#define LOG102LOW  5.27074231034726570126349709198449199648263806413338306011695522101945243775844573974609375e-17

#define C5 8.7979072619215642481194095125829335302114486694335937500000000000000000e-02
#define C4 -1.0861350240983312642750746590536436997354030609130859375000000000000000e-01
#define C3 1.4476512372779321013993580891110468655824661254882812500000000000000000e-01
#define C2  -2.1714724168578289353881416445801733061671257019042968750000000000000000e-01
#define C1 4.3429448190365405046975411096354946494102478027343750000000000000000000e-01


/* 
Polynomial: y=0.0000000000000000000000000000000000000000000000000000000000000000000000e+00 x^(0) + 4.3429448190365405046975411096354946494102478027343750000000000000000000e-01 x^(1) + -2.1714724168578289353881416445801733061671257019042968750000000000000000e-01 x^(2) + 1.4476512372779321013993580891110468655824661254882812500000000000000000e-01 x^(3) + -1.0861350240983312642750746590536436997354030609130859375000000000000000e-01 x^(4) + 8.7979072619215642481194095125829335302114486694335937500000000000000000e-02 x^(5)

*/

float rlibm_fast_log10(float x){

  float_x fix, fit;
  fix.f = x;
  int m = 0;
  
  if (fix.x < 0x800000 || fix.x >= 0x7F800000) {
    if ((fix.x & 0x7FFFFFFF) == 0) { // log(+/-0) = -infty
      fix.x = 0xFF800000;
      return fix.f;
    }
    
    if (fix.x > 0x7FFFFFFF) { // Log(-val) = NaN
      return (x - x) / 0;
      
    }
    
    if (fix.x >= 0x7F800000) {
      return x + x;
    }
    
    fix.f *= 8.388608e+06;
    m -= 23;
  }
  
  m += fix.x >> 23;
  m -= 127;
  fix.x &= 0x007FFFFF;
  fix.x |= 0x3F800000;
  
  fit.x = fix.x & 0x007F0000;
  int FIndex = fit.x >> 16;
  fit.x |= 0x3F800000;
  
  double f = fix.f - fit.f;
  f *= log_oneByF[FIndex];

  double y = C5;
  y *= f;
  y += C4;
  y *= f;
  y += C3;
  y *= f;
  y += C2;
  y *= f;
  y += C1;
  y *= f;
  
  y += m * LOG102LOW;
  y += log10_lut[FIndex];
  y += m * LOG102HIGH;
  return y;


}
