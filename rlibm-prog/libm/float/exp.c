#include <math.h>
#include "float_lib.h"
#include "exp2.h"

float rlibm_fast_exp(float x){
  float_x fx;
  fx.f = x;

  // Take care of special cases
  if (0x42b17218 <= fx.x && fx.x <= 0xb3000000) {
        if (fx.x <= 0x7F800000) return 1.0/0.0;
        if (fx.x < 0x80000000) return 0.0/0.0;
        return 1.0;
  }
  
  if (fx.x <= 0x337fffff) {
    return 1.0;
  }
  
  if (fx.x >= 0xc2cff218) {
    if (fx.x <= 0xFF800000) return 0.0;
    return 0.0/0.0;
  }

  // Perform range reduction
  double xp = x * 92.332482616893656768297660164535045623779296875;
  int N = (int)xp;
  int N2 = N % 64;
  if (N2 < 0) N2 += 64;
  int N1 = N - N2;
  
  int M = N1 / 64;
  int J = N2;
  double R = x - N *
    0.01083042469624914509729318723429969395510852336883544921875;
  
  double_x dX;
  dX.d = R;
  
  double y = 0.0;

  /* violated_input is -3.8539766470648828544653952121734619140625000000000000000000000000000000e-03, lb is 9.9615344038951458838226926673087291419506072998046875000000000000000000e-01, ub is 9.9615442555880995278982936724787577986717224121093750000000000000000000e-01
violated_input is 1.2172441701840952532620576675981283187866210937500000000000000000000000e-03, lb is 1.0012179223912005543439818211481906473636627197265625000000000000000000e+00, ub is 1.0012179853125564576998840493615716695785522460937500000000000000000000e+00
Polynomial: y=1.0000000000000008881784197001252323389053344726562500000000000000000000e+00 x^(0) + 1.0000000000003770317391627031611278653144836425781250000000000000000000e+00 x^(1) + 4.9999999994839466888052470494585577398538589477539062500000000000000000e-01 x^(2) + 1.6666664832931166184692983733839355409145355224609375000000000000000000e-01 x^(3) + 4.1667146151544195986637930673168739303946495056152343750000000000000000e-02 x^(4) + 8.4982194422715557485803472559382498729974031448364257812500000000000000e-03 x^(5) */
    
  if(R == -3.8539766470648828544653952121734619140625000000000000000000000000000000e-03) {
    
    y = 9.9615344038951458838226926673087291419506072998046875000000000000000000e-01;
  }
  else if (R == 1.2172441701840952532620576675981283187866210937500000000000000000000000e-03){
    y = 1.0012179223912005543439818211481906473636627197265625000000000000000000e+00;
  }
  else {
    
    y = 8.4982194422715557485803472559382498729974031448364257812500000000000000e-03;
    y *= R;
    
    y += 4.1667146151544195986637930673168739303946495056152343750000000000000000e-02;
    y *= R;

    y += 1.6666664832931166184692983733839355409145355224609375000000000000000000e-01;
    y *= R;

    y += 4.9999999994839466888052470494585577398538589477539062500000000000000000e-01;
    y *= R;
    
    y += 1.0000000000003770317391627031611278653144836425781250000000000000000000e+00 ;
    y *= R;
    
    y += 1.0000000000000008881784197001252323389053344726562500000000000000000000e+00;    
  }

  return y * ldexp(exp2JBy64[J], M);
}
