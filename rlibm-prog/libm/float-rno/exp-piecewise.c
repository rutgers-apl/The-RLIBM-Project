#include <math.h>
#include "float-rno/float_rno_lib.h"
#include "exp2.h"

double rlibm_rno_exp_piecewise(float x) {
  float_x fx;
  fx.f = x;
  
  // Take care of special cases
  if ((fx.x & 0x7FFFFFFF) == 0) return 1.0;

  if (fx.x <= 872415231) {
    if (fx.x <= 864026623) return 1.0000000298023223876953125;
    return 1.0000000894069671630859375;
  }

  if (1118925336 <= fx.x && fx.x <= 3011510272) {
    if (fx.x < 0x80000000) {
      if (fx.x < 0x7F800000) return 3.40282361850336062550457001444955389952e+38;
      if (fx.x == 0x7F800000) return 1.0 / 0.0;
      return 0.0/0.0;
    }
    
    // negative counterpart
    if (fx.x <= 3003121664) return 0.99999998509883880615234375;
    
    return 0.99999995529651641845703125;
  }

  if (fx.x >= 3268407733) {
    if (fx.x == 0xFF800000) return 0.0;
    if (fx.x < 0xFF800000) return ldexp(1.0, -151);
    return 0.0/0.0;
  }
  
  // Perform range reduction
  double xp = x * 92.332482616893656768297660164535045623779296875;
  int N = (int)xp;
  int N2 = N % 64;
  if (N2 < 0) N2 += 64;
  int N1 = N - N2;
  
  int M = N1 / 64;
  int J = N2;
  double R = x - N *
  0.01083042469624914509729318723429969395510852336883544921875;
  
  double_x dX;
  dX.d = R;
  double y;
  
  if (R < -9.64999884445205680094659328460693359375e-08) {
    switch (dX.x) {
      case 0xbf6f925ff5140000:
        y = 9.961534403895146994045717292465269565582275390625e-01;
        break;
      case 0xbf6e08d3e0000000:
        y = 9.9634039402008067742855246251565404236316680908203125e-01;
        break;
      case 0xbf6c57f87ab4d800:
        y = 9.9654606220206354283419614148442633450031280517578125e-01;
        break;
      default:
        // Compute polynomial
        y = 4.14608556646286208202667467048740945756435394287109375e-02;
        y *= R;
        y += 1.66664974141844057786698840573080815374851226806640625e-01;
        y *= R;
        y += 4.999999950368685386337119780364446341991424560546875e-01;
        y *= R;
        y += 9.9999999999743049983180753770284354686737060546875e-01;
        y *= R;
        y += 1.00000000000000088817841970012523233890533447265625;
    }
  } else {
    y = 9.92653422442851644802441768433709512464702129364013671875e-03;
    y *= R;
    y += 4.1627356674036282424555821535250288434326648712158203125e-02;
    y *= R;
    y += 1.666670365190753011486179957501008175313472747802734375e-01;
    y *= R;
    y += 4.99999998438312387438742234735400415956974029541015625e-01;
    y *= R;
    y += 1.0000000000022948309919001985690556466579437255859375;
    y *= R;
    y += 9.99999999999999555910790149937383830547332763671875e-01;
  }
  
  
  
  // Perform output compensation
  y *= ldexp(exp2JBy64[J], M);
  return y;
}
