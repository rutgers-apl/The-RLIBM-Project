#include <math.h>
#include "float-rno/float_rno_lib.h"
#include "exp2.h"

#define MAXVAL 3.40282361850336062550457001444955389952e+38
#define MAXm1VAL 3.40282356779733661637539395458142568448e+38

double rlibm_rno_exp10_piecewise(float x) {
  float_x fx;
  fx.f = x;
  
  // Take care of special cases
  if ((fx.x & 0x7FFFFFFF) == 0) return 1.0;

  if (fx.x <= 861821911) {
    if (fx.x <= 853433304) return 1.0000000298023223876953125;
    return 1.0000000894069671630859375;
  }

  if (1109008539 <= fx.x && fx.x <= 3000916953) {
    if (fx.x < 0x80000000) {
      if (fx.x < 0x7F800000) return 3.40282361850336062550457001444955389952e+38;
      if (fx.x == 0x7F800000) return 1.0 / 0.0;
      return 0.0/0.0;
    }

    // negative counterpart
    if (fx.x <= 2992528344) return 0.99999998509883880615234375;

    return 0.99999995529651641845703125;
  }

  if (fx.x >= 3258228278) {
    if (fx.x == 0xFF800000) return 0.0;
    if (fx.x < 0xFF800000) return ldexp(1.0, -151);
    return 0.0/0.0;
  }

  // If x == 0.0, 1.0, 2.0, ..., 10.0, then it's also special case
  switch(fx.x) {
  case 0x00000000:
  case 0x80000000: return 1.0;
  case 0x3f800000: return 10.0;
  case 0x40000000: return 100.0;
  case 0x40400000: return 1000.0;
  case 0x40800000: return 10000.0;
  case 0x40a00000: return 100000.0;
  case 0x40c00000: return 1000000.0;
  case 0x40e00000: return 10000000.0;
  case 0x41000000: return 100000000.0;
  case 0x41100000: return 1000000000.0;
  case 0x41200000: return 10000000000.0;
  }
  
  // Perform range reduction
  double xp = x * 2.12603398072791179629348334856331348419189453125e+02;
  int N = (int)xp;
  int N2 = N % 64;
  if (N2 < 0) N2 += 64;
  int N1 = N - N2;
  
  int M = N1 / 64;
  int J = N2;
  double R = x - N *
  4.703593682249706219022922226713490090332925319671630859375e-03;
  
  double_x dx;
  dx.d = R;
  // Find the polynomial coefficients to use.
  double y;
  
  if (R < -3.9950776908881380222737789154052734375000000000000000000000000000000000e-08) {
    switch (dx.x) {
      case 0xbf6753fc710c9020:
        y = 9.9346442551231850526249900212860666215419769287109375000000000000000000000000000000000000000000000000e-01;
        break;
      case 0xbf644b4754eaa500:
        y = 9.9431199607985243371643946375115774571895599365234375000000000000000000000000000000000000000000000000e-01;
        break;
      case 0xbf582c1c01d78000:
        y = 9.9660857770005206734964531278819777071475982666015625000000000000000000000000000000000000000000000000e-01;
        break;
      case 0xbf2ec5a000000000:
        y = 9.9945953488349925653011496251565404236316680908203125000000000000000000000000000000000000000000000000e-01;
        break;
      case 0xbf24d0e620000000:
        y = 9.9963435530662547723323996251565404236316680908203125000000000000000000000000000000000000000000000000e-01;
        break;
      default :
        y = 1.1653224336765002355775777687085792422294616699218750000000000000000000e+00;
        y *= R;
        y += 2.0346559768302183712762598588597029447555541992187500000000000000000000e+00;
        y *= R;
        y += 2.6509490202393335422925702005159109830856323242187500000000000000000000e+00;
        y *= R;
        y += 2.3025850929753191032034465024480596184730529785156250000000000000000000e+00;
        y *= R;
        y += 9.9999999999999977795539507496869191527366638183593750000000000000000000e-01;
    }
  } else {
    
    switch (dx.x) {
      case 0x3f551e6d40000000:
        y = 1.0029723644256594017321049250313080847263336181640625000000000000000000000000000000000000000000000000e+00;
        break;
      case 0x3f6d924c938a8000:
        y = 1.0083464751726924912844651771592907607555389404296875000000000000000000000000000000000000000000000000e+00;
        break;
      default :
        y = 1.1776343356976519682888238094164989888668060302734375000000000000000000e+00;
        y *= R;
        y += 2.0346524600070190480494147777790203690528869628906250000000000000000000e+00;
        y *= R;
        y += 2.6509490972430445054897063528187572956085205078125000000000000000000000e+00;
        y *= R;
        y += 2.3025850929742941453071125579299405217170715332031250000000000000000000e+00;
        y *= R;
        y += 1.0000000000000000000000000000000000000000000000000000000000000000000000e+00;
    }
  }
  
  // Perform output compensation
  y *= ldexp(exp2JBy64[J], M);
  return y;
}
