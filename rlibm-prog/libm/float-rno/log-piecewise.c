#include "float-rno/float_rno_lib.h"
#include "float-rno/log.h"
#include <math.h>

#define LN2HIGH 0.69314718055994528622676398299518041312694549560546875

double rlibm_rno_log_piecewise(float x) {
  float_x fix, fit;
  fix.f = x;
  int m = 0;
  
  if (x == 1.0) return 0.0;
  
  if (fix.x < 0x800000 || fix.x >= 0x7F800000) {
    if ((fix.x & 0x7FFFFFFF) == 0) { // log(+/-0) = -infty
      fix.x = 0xFF800000;
      return fix.f;
    }
    
    if (fix.x > 0x7FFFFFFF) return (x - x) / 0; // Log(-val) = NaN
    if (fix.x >= 0x7F800000) return x + x;
    fix.f *= 8.388608e+06;
    m -= 23;
  }
  
  m += fix.x >> 23;
  m -= 127;
  fix.x &= 0x007FFFFF;
  fix.x |= 0x3F800000;
  
  fit.x = fix.x & 0x007F0000;
  int FIndex = fit.x >> 16;
  fit.x |= 0x3F800000;
  
  double f = fix.f - fit.f;
  f *= log_oneByF[FIndex];
  
  // Find the index of polynomial coefficients
  double_x dX;
  dX.d = f;
  double y;
  
  if (f < 2.6440486729702099115424385189498934778384864330291748046875e-03) {
    switch (dX.x) {
      case 0x3f567f6db6db6db7 :
        y = 1.37221286158256705091373905958107570768333971500396728515625e-03;
        break;
      case 0x3f5d6f7e432f7e44 :
        y = 1.79498962637764125117867397563031772733666002750396728515625e-03;
        break;
      case 0x3f5fbd2361d2361e :
        y = 1.93530998631358274776614880607894519926048815250396728515625e-03;
        break;
      case 0x3f657497b425ed09 :
        y = 2.6156484501205783284316641612576859188266098499298095703125e-03;
        break;
      default :
        y = -2.445482171962873041426433928791084326803684234619140625e-01;
        y *= f;
        y += 3.33307051091637773776454878316144458949565887451171875e-01;
        y *= f;
        y += -4.999999543707918103763176986831240355968475341796875e-01;
        y *= f;
        y += 9.9999999997109434435316188682918436825275421142578125e-01;
        y *= f;
        y += 3.5561582641555828772882814400752138495398545041392690535531073692254722e-15;
    }
  } else {
    switch (dX.x) {
      case 0x3f66ab366cd9b367 :
        y = 2.763365556446573112481246425886638462543487548828125e-03;
        break;
      case 0x3f678d3dcb08d3dd :
        y = 2.8708408002322276415807511540378982317633926868438720703125e-03;
        break;
      case 0x3f6c6ae58469ee58 :
        y = 3.462938100579904254772145577589981257915496826171875e-03;
        break;
      case 0x3f6e8a1fd1b7af01 :
        y = 3.7210405045140786291224532789101431262679398059844970703125e-03;
        break;
      case 0x3f73155555555555 :
        y = 4.648197300592433502119948940389804192818701267242431640625e-03;
        break;
      case 0x3f79c0a2c145828b :
        y = 6.267545243451786741994968821245493018068373203277587890625e-03;
        break;
      default :
        y = -2.445858389295476886804436844613519497215747833251953125e-01;
        y *= f;
        y += 3.33276182165024248416074215128901414573192596435546875e-01;
        y *= f;
        y += -4.999997079537947808347553291241638362407684326171875e-01;
        y *= f;
        y += 9.9999999927865956816930292916367761790752410888671875e-01;
        y *= f;
        y += 6.8862937017486202822129343729218372974817258258539709459000732749700546e-13;
    }
  }
  
  y += ln_lutHIGH[FIndex];
  y += m * LN2HIGH;
  
  return y;
}
